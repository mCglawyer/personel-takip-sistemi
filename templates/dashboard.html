{% load static %}
{% load custom_filters %} {# has_group filtresini kullanabilmek için #}
{% load pwa %} {# PWA meta etiketleri için #}
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> {# Mobil uyumluluk için #}
    <title>Ana Panel - Personel Takip</title>
    {% progressive_web_app_meta %} {# PWA meta etiketleri #}

    <style>
        /* Genel Stiller */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 40px; background-color: #f9f9f9; margin: 0;}
        .container { max-width: 1000px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 20px; flex-wrap: wrap;}
        .header h1 { margin: 0; font-size: 1.8rem; margin-bottom: 5px;}
        .header .header-controls { display: flex; align-items: center;} /* Header butonlarını yan yana getir */
        .header .header-controls a { text-decoration: none; padding: 8px 15px; border-radius: 5px; font-weight: 600; white-space: nowrap; margin-left: 10px; display: inline-block; transition: opacity 0.2s ease;}
        .header .header-controls a:hover { opacity: 0.85; }
        .header a.profile-link { background-color: #17a2b8; color: white;} /* Profilim butonu */
        .header a.logout-button { background-color: #d93025; color: white;} /* Çıkış butonu */
        .content h2 { margin-top: 30px; border-bottom: 1px solid #eee; padding-bottom: 10px;}

        /* Başarı/Uyarı/Bilgi Mesajı Stili */
        .alert { padding: 15px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 4px; }
        .alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
        .alert-warning { color: #856404; background-color: #fff3cd; border-color: #ffeeba; }
        .alert-info { color: #0c5460; background-color: #d1ecf1; border-color: #bee5eb; }
        .alert-error { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; } /* Hata mesajları için */

        /* --- SADECE YÖNETİCİ GÖRÜNÜMÜ STİLLERİ --- */
        .admin-controls { margin-bottom: 20px;}
        .admin-controls a.report-link { display: inline-block; background-color: #e8590c; color: white; padding: 10px 16px; text-decoration: none; font-weight: 600; border-radius: 5px; margin-bottom: 10px; margin-right: 10px; transition: opacity 0.2s ease;}
        .admin-controls a.report-link:hover { opacity: 0.8; }
        .admin-controls a.report-link.weekly-link { background-color: #1a73e8; }
        .admin-controls a.report-link.personnel-link { background-color: #ffc107; color: #333;}
        .admin-controls a.report-link.pending-link { background-color: #fd7e14; } /* Bekleyen talepler */
        .admin-controls a.report-link.break-report-link { background-color: #17a2b8; }
        .admin-controls a.report-link.attendance-report-link { background-color: #28a745; }

        .report-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .report-table th, .report-table td { border: 1px solid #ddd; padding: 10px 12px; text-align: left; font-size: 0.95rem;}
        .report-table th { background-color: #f4f4f4; font-weight: 600; }
        .report-table tbody tr:nth-child(odd) { background-color: #f9f9f9; }
        .status-active { color: #e63946; font-weight: bold; }

        /* --- SADECE PERSONEL GÖRÜNÜMÜ STİLLERİ --- */
        .personnel-controls { margin-bottom: 25px; }
        .personnel-controls a { display: inline-block; padding: 10px 18px; background-color: #ffc107; color: #333; text-decoration: none; border-radius: 5px; font-weight: 600; margin-right: 10px; transition: opacity 0.2s ease;}
        .personnel-controls a:hover { opacity: 0.85; }
        .personnel-controls a.requests-link { background-color: #6c757d; color: white; } /* Taleplerim butonu */
        .personnel-controls a.qr-scan-link { background-color: #007bff; color: white; } /* QR Tarayıcı butonu */
        .personnel-welcome { font-size: 1.5rem; color: #333; margin-bottom: 25px; }
        .status-box { padding: 20px; border-radius: 8px; margin-bottom: 25px; border: 1px solid; }
        .status-box.active-break { background-color: #fff0f0; border-color: #d93025; color: #721c24; }
        .status-box.no-break { background-color: #f0fff4; border-color: #28a745; color: #155724; }
        .status-box h3 { margin-top: 0; font-size: 1.2rem;}
        .status-box p { font-size: 1rem; margin-bottom: 5px;}
        .status-box em { font-size: 0.9rem; color: #555;}

        /* FullCalendar Stilleri */
        #calendar { max-width: 900px; margin: 20px auto; background-color: white; padding: 15px; border-radius: 5px; box-shadow: 0 1px 5px rgba(0,0,0,0.1); }
        .fc-event { border-width: 1px !important; cursor: default !important; }
        .fc-daygrid-event-dot { display: none; }
        .fc-event-title { white-space: normal !important; font-size: 0.85em; padding: 2px 4px;}
        .fc .fc-daygrid-day-number { padding: 4px; }
        .fc .fc-col-header-cell-cushion { padding: 5px 4px; }

        /* --- MOBİL UYUMLULUK --- */
        @media (max-width: 768px) {
            body { padding: 15px; }
            .container { padding: 15px; }
            .header { flex-direction: column; align-items: flex-start; }
            .header h1 { font-size: 1.6rem; margin-bottom: 10px; }
            .header .header-controls { margin-top: 10px; width: 100%; text-align: right;} /* Butonları sağa al */
            .content h2 { font-size: 1.3rem; }
            /* Yönetici Butonları Alt Alta Gelsin */
             .admin-controls a.report-link { display: block; margin-right: 0; text-align: center;}
             /* Personel Butonları Alt Alta Gelsin */
             .personnel-controls a { display: block; margin-right: 0; text-align: center; margin-bottom: 10px;}

            .personnel-welcome { font-size: 1.3rem; }
            .status-box { padding: 15px; }
            .status-box h3 { font-size: 1.1rem; }
            .status-box p { font-size: 0.95rem; }

            /* FullCalendar Ayarları */
            #calendar { padding: 5px; margin: 10px auto; }
            .fc .fc-toolbar-title { font-size: 1.1em; }
            .fc .fc-button { padding: 0.3em 0.5em; font-size: 0.9em; }
            .fc-event-title { font-size: 0.8em !important; }
            .fc .fc-col-header-cell-cushion { font-size: 0.85em; padding: 3px; }
        }

        @media (max-width: 480px) {
             .header h1 { font-size: 1.4rem; }
             .content h2 { font-size: 1.1rem; }
             .personnel-welcome { font-size: 1.1rem; }
             .fc .fc-header-toolbar { font-size: 0.9em; }
             .fc .fc-daygrid-day-number { font-size: 0.9em; padding: 2px; }
             .fc-event-title { font-size: 0.75em !important; }
             .header .header-controls a { padding: 6px 10px; font-size: 0.9rem;} /* Header butonlarını küçült */
             .admin-controls a.report-link { padding: 8px 12px; font-size: 0.9rem; } /* Admin butonlarını küçült */
             .personnel-controls a { padding: 8px 14px; font-size: 0.9rem; } /* Personel butonunu küçült */
        }
    </style>

    {% if not is_admin %}
        <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
        <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core/locales/tr.global.min.js'></script>
    {% endif %}

</head>
<body>

    <div class="container">

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags|default:'info' }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
        {# ==================================================================== #}
        {# VIEW'dan gelen 'is_admin' değişkenine göre içerik değişir           #}
        {# is_admin artık yönetici (superuser, şef, bölge yön.) anlamına geliyor #}
        {# ==================================================================== #}

        {% if is_admin %}

            <div class="header">
                <h1>Yönetici Paneli</h1>
                 <div class="header-controls">
                    <a href="{% url 'accounts:profile' %}" class="profile-link">Profilim</a>
                    <a href="{% url 'accounts:logout' %}" class="logout-button">Çıkış Yap</a>
                 </div>
            </div>

            <div class="content">
                <div class="admin-controls">
                    <a href="{% url 'accounts:weekly_schedule_select' %}" class="report-link weekly-link">
                         Haftalık Vardiya Planla
                    </a>
                    <a href="{% url 'accounts:personnel_list' %}" class="report-link personnel-link">
                         Personel Yönetimi
                    </a>
                    <a href="{% url 'accounts:pending_leave_requests' %}" class="report-link pending-link">
                         Bekleyen İzin/Rapor Talepleri
                    </a>

                    {# Sadece Rapor Görme Yetkisi Olanlar (Superuser, Bölge Yön.) Görsün #}
                    {% if user|has_group:"Bölge Yöneticisi" or user.is_superuser %}
                        <a href="{% url 'accounts:exceeded_breaks_report' %}" class="report-link">
                             Mola Süresini Aşanlar
                        </a>
                        <a href="{% url 'accounts:break_report_select' %}" class="report-link break-report-link">
                             Haftalık Mola Raporu
                        </a>
                        <a href="{% url 'accounts:attendance_report_select' %}" class="report-link attendance-report-link">
                             Aylık Puantaj Raporu
                        </a>
                    {% endif %}
                </div>

                <h2>{{ report_title|default:"Genel Mola Takip Raporu" }}</h2>
                <p>Şu anda aktif (bitmemiş) mola sayısı: <strong>{{ active_breaks_count }}</strong></p>

                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Personel</th>
                            <th>Şube</th>
                            <th>Mola Başlangıç</th>
                            <th>Mola Bitiş / Durum</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for break in all_breaks_list %}
                        <tr>
                            <td>{{ break.personnel.username }}</td>
                            <td>{{ break.branch.name|default:"-" }}</td>
                            <td>{{ break.start_time|date:"d N Y, H:i:s" }}</td>
                            <td>
                                {% if break.end_time %}
                                    {{ break.end_time|date:"d N Y, H:i:s" }}
                                {% else %}
                                    <span class="status-active">Devam Ediyor...</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" style="text-align: center;">Gösterilecek mola kaydı bulunmamaktadır.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        {% else %}

            <div class="header">
                <h1>Hoş Geldin, {{ user.first_name|default:user.username }}!</h1>
                <div class="header-controls">
                    <a href="{% url 'accounts:profile' %}" class="profile-link">Profilim</a>
                    <a href="{% url 'accounts:logout' %}" class="logout-button">Çıkış Yap</a>
                </div>
            </div>

            <div class="content">
                <p class="personnel-welcome">Kullanıcı Ekranı</p>

                 <div class="personnel-controls">
                    {# QR Tarayıcı Butonu #}
                    <a href="{% url 'accounts:qr_scanner' %}" class="qr-scan-link">
                         Mola QR Kodu Tara
                    </a>
                    <a href="{% url 'accounts:leave_request_create' %}">
                        Yeni İzin/Rapor Talebi Oluştur
                    </a>
                    <a href="{% url 'accounts:my_leave_requests' %}" class="requests-link">
                        Taleplerim
                    </a>
                </div>


                {% if active_break %}
                    <div class="status-box active-break">
                        <h3>MOLA DURUMU: AKTİF</h3>
                        <p>Şu anda <strong>{{ active_break.branch.name|default:'Bilinmeyen Şube' }}</strong> şubesinde moladasınız.</p>
                        <p>Mola başlangıç saatiniz: <strong>{{ active_break.start_time|date:"H:i:s" }}</strong></p>
                        <p style="margin-top: 10px;"><em>Molayı bitirmek için lütfen ilgili şubenin QR kodunu tekrar okutun.</em></p>
                    </div>
                {% else %}
                    <div class="status-box no-break">
                        <h3>MOLA DURUMU: AKTİF DEĞİL</h3>
                        <p>Şu anda çalışıyorsunuz.</p>
                        <p style="margin-top: 10px;"><em>Mola başlatmak için lütfen ilgili şubenin QR kodunu okutun.</em></p>
                    </div>
                {% endif %}

                <h2>Haftalık Vardiya Takvimi <small>({{ start_of_week|date:"W" }}. Hafta)</small></h2>
                <div id='calendar'></div>

            </div> {% endif %} {# is_admin kontrolü bitti #}

    </div> {% if not is_admin %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            if (calendarEl) {
                try {
                    var eventsData = JSON.parse('{{ calendar_events_json|safe|escapejs }}');
                    var calendar = new FullCalendar.Calendar(calendarEl, {
                        locale: 'tr',
                        headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
                        initialView: 'dayGridWeek',
                        firstDay: 1,
                        height: 'auto',
                        events: eventsData,
                        eventDisplay: 'block',
                        eventTextColor: '#373629',
                        eventMouseEnter: function(info) {
                          if (info.event.extendedProps && info.event.extendedProps.branch) {
                            info.el.title = 'Şube: ' + info.event.extendedProps.branch;
                          } else {
                              if (!['İzinli', 'Raporlu', 'Devamsız', 'Fazla Mesai'].includes(info.event.title.split(' ')[0])) {
                                   info.el.title = info.event.title;
                              }
                          }
                        },
                        windowResize: function(view) {
                            if (window.innerWidth < 768) { calendar.setOption('height', 500); calendar.setOption('contentHeight', 450); }
                            else { calendar.setOption('height', 'auto'); calendar.setOption('contentHeight', 500); }
                        }
                    });
                    calendar.render();
                    if (window.innerWidth < 768) { calendar.setOption('height', 500); calendar.setOption('contentHeight', 450); }
                } catch (e) {
                    console.error("Takvim hatası:", e);
                    calendarEl.innerHTML = "<p style='color: red; text-align: center; padding: 20px;'>Vardiya takvimi yüklenirken bir sorun oluştu.</p>";
                }
            } else { console.error("Takvim elementi ('#calendar') bulunamadı."); }
        });
    </script>
    {% endif %}

</body>
</html>