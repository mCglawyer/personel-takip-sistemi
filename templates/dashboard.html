{% extends 'base.html' %} {# Ana şablonu (kahve temalı) miras alır #}
{% load static %}
{# {% load custom_filters %} #}  <-- BU SATIRI YORUM YAPIN VEYA SİLİN
{% load pwa %}
{# Sayfa başlığını base.html'e gönder #}
{% block title %}Ana Panel - {{ user.username }}{% endblock %}

{# Bu sayfaya özel CSS'leri head bloğuna gönder #}
{% block head_styles %}
    {% if not is_admin %}
    {# Personel görünümü için FullCalendar stilleri #}
    <style>
        #calendar { max-width: 900px; margin: 20px auto; background-color: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 5px rgba(0,0,0,0.1); }
        .fc-event { border-width: 1px !important; cursor: default !important; }
        .fc-daygrid-event-dot { display: none; }
        .fc-event-title { white-space: normal !important; font-size: 0.85em; padding: 2px 4px;}
        .fc .fc-daygrid-day-number { padding: 4px; }
        .fc .fc-col-header-cell-cushion { padding: 5px 4px; }

        /* Personel butonları için özel stil (base.html'dekine ek) */
        .personnel-controls { margin-bottom: 25px; }
        .personnel-controls a { display: inline-block; padding: 10px 18px; text-decoration: none; border-radius: 5px; font-weight: 600; margin-right: 10px; margin-bottom: 10px; transition: opacity 0.2s ease;}
        .personnel-controls a:hover { opacity: 0.85; }
        .personnel-controls a.requests-link { background-color: #6c757d; color: white; } /* Taleplerim butonu */
        .personnel-controls a.qr-scan-link { background-color: #007bff; color: white; } /* QR Tarayıcı (Bootstrap mavisi) */
        
        /* Mola Durumu Kutusu Stilleri */
        .status-box { padding: 20px; border-radius: 8px; margin-bottom: 25px; border: 1px solid; }
        .status-box.active-break { background-color: #fff0f0; border-color: #d93025; color: #721c24; }
        .status-box.no-break { background-color: #f0fff4; border-color: #28a745; color: #155724; }
        .status-box h3 { margin-top: 0; font-size: 1.2rem;}
        .status-box p { font-size: 1rem; margin-bottom: 5px;}
        .status-box em { font-size: 0.9rem; color: #555;}
        
        /* Mobil uyumluluk */
        @media (max-width: 768px) {
            #calendar { padding: 5px; margin: 10px auto; }
            .fc .fc-toolbar-title { font-size: 1.1em; }
            .fc .fc-button { padding: 0.3em 0.5em; font-size: 0.9em; }
            .fc-event-title { font-size: 0.8em !important; }
            .fc .fc-col-header-cell-cushion { font-size: 0.85em; padding: 3px; }
            .personnel-controls a { display: block; margin-right: 0; text-align: center; }
        }
        @media (max-width: 480px) {
             .fc .fc-header-toolbar { font-size: 0.9em; }
             .fc .fc-daygrid-day-number { font-size: 0.9em; padding: 2px; }
             .fc-event-title { font-size: 0.75em !important; }
             .personnel-controls a { padding: 8px 14px; font-size: 0.9rem; }
        }
    </style>
    {% else %}
    {# Yönetici görünümü için stiller #}
    <style>
        .admin-controls { margin-bottom: 20px;}
        .admin-controls a.btn { 
            margin-right: 10px; 
            margin-bottom: 10px; 
            font-weight: 600;
        }
        /* Yönetici Mola Kutusu Stilleri */
        .status-box { padding: 20px; border-radius: 8px; margin-bottom: 25px; border: 1px solid; }
        .status-box.active-break { background-color: #fff0f0; border-color: #d93025; color: #721c24; }
        .status-box.no-break { background-color: #f0fff4; border-color: #28a745; color: #155724; }
        .status-box h3 { margin-top: 0; font-size: 1.2rem;}
        .status-box p { font-size: 1rem; margin-bottom: 5px;}
        .personnel-controls { margin-bottom: 25px; }
        .personnel-controls a { display: inline-block; padding: 10px 18px; text-decoration: none; border-radius: 5px; font-weight: 600; margin-right: 10px; margin-bottom: 10px; transition: opacity 0.2s ease;}
        .personnel-controls a:hover { opacity: 0.85; }
        .personnel-controls a.requests-link { background-color: #6c757d; color: white; }
        .personnel-controls a.qr-scan-link { background-color: #007bff; color: white; }
        
        @media (max-width: 768px) {
            .admin-controls a.btn { display: block; margin-right: 0; }
            .personnel-controls a { display: block; margin-right: 0; text-align: center; }
        }
        @media (max-width: 480px) {
             .admin-controls a.btn { padding: 8px 12px; font-size: 0.9rem; }
             .personnel-controls a { padding: 8px 14px; font-size: 0.9rem; }
        }
    </style>
    {% endif %}
{% endblock %}


{# Ana içerik bloğunu doldur #}
{% block content %}

    {# ==================================================================== #}
    {# YÖNETİCİ GÖRÜNÜMÜ #}
    {# ==================================================================== #}
    {% if is_admin %}
        <div class="card shadow-sm">
            <div class="card-header bg-light py-3">
                <h1 class="h4 mb-0">Yönetici Paneli</h1>
            </div>
            <div class="card-body p-4">
                
          <div class="d-flex flex-wrap">
    <a href="{% url 'accounts:weekly_schedule_select' %}" class="btn btn-coffee"><i class="bi bi-calendar-week"></i> Haftalık Vardiya Planla</a>
    <a href="{% url 'accounts:personnel_list' %}" class="btn btn-coffee"><i class="bi bi-people-fill"></i> Personel Yönetimi</a>
    <a href="{% url 'accounts:pending_leave_requests' %}" class="btn btn-coffee"><i class="bi bi-clock-history"></i> Bekleyen İzin Talepleri</a>

    {# --- IF BLOĞU GEÇİCİ OLARAK KALDIRILDI --- #}
    {# Bu butonları artık TÜM yöneticiler (Şefler dahil) görecek #}
    <a href="{% url 'accounts:exceeded_breaks_report' %}" class="btn btn-coffee-light"><i class="bi bi-exclamation-triangle"></i> Mola Süresini Aşanlar</a>
    <a href="{% url 'accounts:break_report_select' %}" class="btn btn-coffee-light"><i class="bi bi-graph-up"></i> Haftalık Mola Raporu</a>
    <a href="{% url 'accounts:attendance_report_select' %}" class="btn btn-coffee-light"><i class="bi bi-file-earmark-spreadsheet"></i> Aylık Puantaj Raporu</a>
    {# --- IF BLOĞU SONU --- #}
</div>
                </div>

                <h3 class="h5 mt-4">Kişisel Mola Durumu</h3>
                <div class="personnel-controls mb-3">

                    {# GEÇİCİ TEST BUTONU (QR Kod sorununu atlamak için) #}
                    {# '1' sayısını canlı veritabanınızdaki geçerli bir Şube ID'si ile değiştirin! #}
                    <a href="{% url 'accounts:toggle_break' 1 %}" 
                       class="btn" 
                       style="background-color: #e63946; color: white; font-weight: bold; border: 2px solid #333;"
                       onclick="return confirm('Bu bir test butonudur. Şube 1 için mola başlatılsın mı?');">
                        MOLA BAŞLAT/BİTİR (TEST BUTONU - ŞUBE 1)
                    </a>
                    
                    <a href="{% url 'accounts:qr_scanner' %}" class="btn btn-coffee qr-scan-link"><i class="bi bi-qr-code-scan"></i> Mola QR Kodu Tara</a>
                    <a href="{% url 'accounts:my_leave_requests' %}" class="btn btn-secondary requests-link"><i class="bi bi-list-check"></i> Taleplerim</a>
                </div>

                {% if active_break %}
                    <div class="alert alert-danger shadow-sm status-box active-break">
                        <h3 class="alert-heading"><i class="bi bi-pause-circle-fill"></i> MOLA DURUMU: AKTİF</h3>
                        <p>Şu anda <strong>{{ active_break.branch.name|default:'Bilinmeyen Şube' }}</strong> şubesinde moladasınız.</p>
                        <hr>
                        <p class="mb-0">Başlangıç: <strong>{{ active_break.start_time|date:"H:i:s" }}</strong>. <em>Bitirmek için QR kodu tekrar okutun veya Test Butonuna basın.</em></p>
                    </div>
                {% else %}
                    <div class="alert alert-success shadow-sm status-box no-break">
                        <h3 class="alert-heading"><i class="bi bi-play-circle-fill"></i> MOLA DURUMU: AKTİF DEĞİL</h3>
                        <p class="mb-0">Şu anda çalışıyorsunuz. <em>Mola başlatmak için QR kodu okutun veya Test Butonuna basın.</em></p>
                    </div>
                {% endif %}
                <h2 class="h5 mt-4">{{ report_title|default:"Genel Mola Takip Raporu" }}</h2>
                <p class="text-muted">Şu anda aktif (bitmemiş) mola sayısı: <strong>{{ active_breaks_count }}</strong></p>

                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Personel</th>
                                <th>Şube</th>
                                <th>Mola Başlangıç</th>
                                <th>Mola Bitiş / Durum</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for break in all_breaks_list %}
                            <tr>
                                <td>{{ break.personnel.username }}</td>
                                <td>{{ break.branch.name|default:"-" }}</td>
                                <td>{{ break.start_time|date:"d N Y, H:i:s" }}</td>
                                <td>
                                    {% if break.end_time %}
                                        {{ break.end_time|date:"d N Y, H:i:s" }}
                                    {% else %}
                                        <span class="badge bg-danger">Devam Ediyor...</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center py-4">Gösterilecek mola kaydı bulunmamaktadır.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    {# ==================================================================== #}
    {# PERSONEL GÖRÜNÜMÜ #}
    {# ==================================================================== #}
    {% else %}
        
        <h1 class="h3 mb-4">Kullanıcı Ekranı</h1>

        <div class="personnel-controls">

            {# GEÇİCİ TEST BUTONU (QR Kod sorununu atlamak için) #}
            {# '1' sayısını canlı veritabanınızdaki geçerli bir Şube ID'si ile değiştirin! #}
            <a href="{% url 'accounts:toggle_break' 1 %}" 
               class="btn" 
               style="background-color: #e63946; color: white; font-weight: bold; border: 2px solid #333;"
               onclick="return confirm('Bu bir test butonudur. Şube 1 için mola başlatılsın mı?');">
                MOLA BAŞLAT/BİTİR (TEST BUTONU - ŞUBE 1)
            </a>

            <a href="{% url 'accounts:qr_scanner' %}" class="btn btn-coffee qr-scan-link"><i class="bi bi-qr-code-scan"></i> Mola QR Kodu Tara</a>
            <a href="{% url 'accounts:leave_request_create' %}" class="btn btn-coffee-light"><i class="bi bi-send-plus"></i> Yeni İzin/Rapor Talebi</a>
            <a href="{% url 'accounts:my_leave_requests' %}" class="btn btn-secondary requests-link"><i class="bi bi-list-check"></i> Taleplerim</a>
        </div>

        {% if active_break %}
            <div class="alert alert-danger shadow-sm status-box active-break">
                <h3 class="alert-heading"><i class="bi bi-pause-circle-fill"></i> MOLA DURUMU: AKTİF</h3>
                <p>Şu anda <strong>{{ active_break.branch.name|default:'Bilinmeyen Şube' }}</strong> şubesinde moladasınız.</p>
                <hr>
                <p class="mb-0">Başlangıç: <strong>{{ active_break.start_time|date:"H:i:s" }}</strong>. <em>Molayı bitirmek için QR kodu okutun veya Test Butonuna basın.</em></p>
            </div>
        {% else %}
            <div class="alert alert-success shadow-sm status-box no-break">
                <h3 class="alert-heading"><i class="bi bi-play-circle-fill"></i> MOLA DURUMU: AKTİF DEĞİL</h3>
                <p class="mb-0">Şu anda çalışıyorsunuz. <em>Mola başlatmak için QR kodu okutun veya Test Butonuna basın.</em></p>
            </div>
        {% endif %}

        <div class="card shadow-sm mt-4">
            <div class="card-header bg-white">
                <h2 class="h5 mb-0">Haftalık Vardiya Takvimi <small class="text-muted">({{ start_of_week|date:"W" }}. Hafta)</small></h2>
            </div>
            <div class="card-body">
                {# FullCalendar buraya render edilecek #}
                <div id='calendar'></div>
            </div>
        </div>

    {% endif %} {# is_admin kontrolü bitti #}
{% endblock %}


{# FullCalendar için script'leri base.html'deki scripts bloğuna gönder #}
{% block scripts %}
    {% if not is_admin %}
        {# FullCalendar CDN script'leri #}
        <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
        <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core/locales/tr.global.min.js'></script>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var calendarEl = document.getElementById('calendar');
                if (calendarEl) {
                    try {
                        var eventsData = JSON.parse('{{ calendar_events_json|safe|escapejs }}');
                        var calendar = new FullCalendar.Calendar(calendarEl, {
                            locale: 'tr',
                            headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
                            initialView: 'dayGridWeek',
                            firstDay: 1,
                            height: 'auto',
                            events: eventsData,
                            eventDisplay: 'block',
                            eventTextColor: '#373629',
                            eventMouseEnter: function(info) {
                              if (info.event.extendedProps && info.event.extendedProps.branch) {
                                info.el.title = 'Şube: ' + info.event.extendedProps.branch;
                              } else {
                                  if (!['İzinli', 'Raporlu', 'Devamsız', 'Fazla Mesai'].includes(info.event.title.split(' ')[0])) {
                                       info.el.title = info.event.title;
                                  }
                              }
                            },
                            // ... (Mobil resize script'i buraya eklenebilir) ...
                        });
                        calendar.render();
                    } catch (e) {
                        console.error("Takvim hatası:", e);
                        calendarEl.innerHTML = "<div class='alert alert-danger'>Vardiya takvimi yüklenirken bir sorun oluştu.</div>";
                    }
                }
            });
        </script>
    {% endif %}
{% endblock %}