{% extends 'base.html' %}
{% load static %}
{% load custom_filters %} {# has_group filtresini kullanabilmek için #}

{# Sayfa başlığını base.html'e gönder #}
{% block title %}Ana Panel - {{ user.username }}{% endblock %}

{# FullCalendar için stiller (Sadece personel görürse) #}
{% block head_styles %}
    {% if not is_admin %}
    <style>
        #calendar { max-width: 900px; margin: 20px auto; background-color: white; padding: 15px; border-radius: 5px; box-shadow: 0 1px 5px rgba(0,0,0,0.1); }
        .fc-event { border-width: 1px !important; cursor: default !important; }
        .fc-daygrid-event-dot { display: none; }
        .fc-event-title { white-space: normal !important; font-size: 0.85em; padding: 2px 4px;}
        .fc .fc-daygrid-day-number { padding: 4px; }
        .fc .fc-col-header-cell-cushion { padding: 5px 4px; }

        /* Mobil uyumluluk (base.html'dekine ek olarak) */
        @media (max-width: 768px) {
            #calendar { padding: 5px; margin: 10px auto; }
            .fc .fc-toolbar-title { font-size: 1.1em; }
            .fc .fc-button { padding: 0.3em 0.5em; font-size: 0.9em; }
            .fc-event-title { font-size: 0.8em !important; }
            .fc .fc-col-header-cell-cushion { font-size: 0.85em; padding: 3px; }
        }
        @media (max-width: 480px) {
             .fc .fc-header-toolbar { font-size: 0.9em; }
             .fc .fc-daygrid-day-number { font-size: 0.9em; padding: 2px; }
             .fc-event-title { font-size: 0.75em !important; }
        }
    </style>
    {% endif %}
{% endblock %}


{# Ana içerik bloğunu doldur #}
{% block content %}

    {# ==================================================================== #}
    {# YÖNETİCİ GÖRÜNÜMÜ #}
    {# ==================================================================== #}
    {% if is_admin %}
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h1 class="h4 mb-0">Yönetici Paneli</h1>
            </div>
            <div class="card-body">

                <div class="admin-controls mb-4 p-3 bg-light rounded border">
                    <h3 class="h5 mb-3 border-bottom pb-2">Yönetim Araçları</h3>
                    <div class="d-flex flex-wrap"> {# Butonları yan yana sırala ve sar #}
                        {# Şef ve üstü için butonlar #}
                        <a href="{% url 'accounts:weekly_schedule_select' %}" class="btn btn-coffee me-2 mb-2"><i class="bi bi-calendar-week"></i> Haftalık Vardiya Planla</a>
                        <a href="{% url 'accounts:personnel_list' %}" class="btn btn-coffee me-2 mb-2"><i class="bi bi-people-fill"></i> Personel Yönetimi</a>
                        <a href="{% url 'accounts:pending_leave_requests' %}" class="btn btn-coffee me-2 mb-2"><i class="bi bi-clock-history"></i> Bekleyen İzin Talepleri</a>

                        {# Sadece Bölge Yöneticisi ve Superuser için Rapor Butonları #}
                        {% if user|has_group:"Bölge Yöneticisi" or user.is_superuser %}
                            <a href="{% url 'accounts:exceeded_breaks_report' %}" class="btn btn-coffee-light me-2 mb-2"><i class="bi bi-exclamation-triangle"></i> Mola Süresini Aşanlar</a>
                            <a href="{% url 'accounts:break_report_select' %}" class="btn btn-coffee-light me-2 mb-2"><i class="bi bi-graph-up"></i> Haftalık Mola Raporu</a>
                            <a href="{% url 'accounts:attendance_report_select' %}" class="btn btn-coffee-light me-2 mb-2"><i class="bi bi-file-earmark-spreadsheet"></i> Aylık Puantaj Raporu</a>
                        {% endif %}
                    </div>
                </div>

                <h2 class="h5 mt-4">{{ report_title|default:"Genel Mola Takip Raporu" }}</h2>
                <p class="text-muted">Şu anda aktif (bitmemiş) mola sayısı: <strong>{{ active_breaks_count }}</strong></p>

                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover table-sm"> {# Bootstrap tablo stilleri #}
                        <thead class="table-light"> {# Başlık için daha açık renk #}
                            <tr>
                                <th>Personel</th>
                                <th>Şube</th>
                                <th>Mola Başlangıç</th>
                                <th>Mola Bitiş / Durum</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for break in all_breaks_list %}
                            <tr>
                                <td>{{ break.personnel.username }}</td>
                                <td>{{ break.branch.name|default:"-" }}</td>
                                <td>{{ break.start_time|date:"d N Y, H:i:s" }}</td>
                                <td>
                                    {% if break.end_time %}
                                        {{ break.end_time|date:"d N Y, H:i:s" }}
                                    {% else %}
                                        <span class="badge bg-danger">Devam Ediyor...</span> {# Bootstrap Badge #}
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center py-4">Gösterilecek mola kaydı bulunmamaktadır.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    {# ==================================================================== #}
    {# PERSONEL GÖRÜNÜMÜ #}
    {# ==================================================================== #}
    {% else %}

        <h1 class="h3 mb-4">Kullanıcı Ekranı</h1>

        <div class="personnel-controls mb-4">
            {# Butonları kahve tonlarına güncelledik #}
            <a href="{% url 'accounts:qr_scanner' %}" class="btn btn-coffee"><i class="bi bi-qr-code-scan"></i> Mola QR Kodu Tara</a>
            <a href="{% url 'accounts:leave_request_create' %}" class="btn btn-coffee-light"><i class="bi bi-send-plus"></i> Yeni İzin/Rapor Talebi</a>
            <a href="{% url 'accounts:my_leave_requests' %}" class="btn btn-secondary requests-link"><i class="bi bi-list-check"></i> Taleplerim</a>
        </div>

        {% if active_break %}
            <div class="alert alert-danger shadow-sm">
                <h4 class="alert-heading"><i class="bi bi-pause-circle-fill"></i> MOLA DURUMU: AKTİF</h4>
                <p>Şu anda <strong>{{ active_break.branch.name|default:'Bilinmeyen Şube' }}</strong> şubesinde moladasınız.</p>
                <hr>
                <p class="mb-0">Başlangıç: <strong>{{ active_break.start_time|date:"H:i:s" }}</strong>. Molayı bitirmek için QR kodu tekrar okutun.</p>
            </div>
        {% else %}
            <div class="alert alert-success shadow-sm">
                <h4 class="alert-heading"><i class="bi bi-play-circle-fill"></i> MOLA DURUMU: AKTİF DEĞİL</h4>
                <p class="mb-0">Şu anda çalışıyorsunuz. Mola başlatmak için QR kodu okutun.</p>
            </div>
        {% endif %}

        <div class="card shadow-sm mt-4">
            <div class="card-header bg-white">
                <h2 class="h5 mb-0">Haftalık Vardiya Takvimi <small class="text-muted">({{ start_of_week|date:"W" }}. Hafta)</small></h2>
            </div>
            <div class="card-body">
                {# FullCalendar buraya render edilecek #}
                <div id='calendar'></div>
            </div>
        </div>

    {% endif %} {# is_admin kontrolü bitti #}
{% endblock %}


{# FullCalendar için script'leri base.html'deki scripts bloğuna gönder #}
{% block scripts %}
    {% if not is_admin %}
        {# FullCalendar CDN script'leri (Head'den buraya taşındı, daha iyi performans) #}
        <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
        <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core/locales/tr.global.min.js'></script>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var calendarEl = document.getElementById('calendar');
                if (calendarEl) {
                    try {
                        var eventsData = JSON.parse('{{ calendar_events_json|safe|escapejs }}');
                        var calendar = new FullCalendar.Calendar(calendarEl, {
                            locale: 'tr',
                            headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
                            initialView: 'dayGridWeek',
                            firstDay: 1,
                            height: 'auto',
                            events: eventsData,
                            eventDisplay: 'block',
                            eventTextColor: '#373629',
                            eventMouseEnter: function(info) {
                              if (info.event.extendedProps && info.event.extendedProps.branch) {
                                info.el.title = 'Şube: ' + info.event.extendedProps.branch;
                              } else {
                                  if (!['İzinli', 'Raporlu', 'Devamsız', 'Fazla Mesai'].includes(info.event.title.split(' ')[0])) {
                                       info.el.title = info.event.title;
                                  }
                              }
                            },
                            // ... (Mobil uyumluluk için windowResize vb. script'ler eklenebilir) ...
                        });
                        calendar.render();
                    } catch (e) {
                        console.error("Takvim hatası:", e);
                        calendarEl.innerHTML = "<div class='alert alert-danger'>Vardiya takvimi yüklenirken bir sorun oluştu.</div>";
                    }
                }
            });
        </script>
    {% endif %}
{% endblock %}