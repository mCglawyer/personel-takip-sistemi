{% extends 'base.html' %} {# Ana şablonu (kahve temalı navbar vb.) miras alır #}
{% load static %}
{% load pwa %}

{% block title %}Mola QR Kodu Tarayıcı{% endblock %}

{# Bu sayfaya özel stilleri head bloğuna gönder #}
{% block head_styles %}
<style>
    /* Tarayıcıyı ortalamak için */
    main.container {
        max-width: 600px; /* Konteyneri daralt */
    }

    #qr-reader-wrapper {
        max-width: 500px;
        margin: 0 auto 20px auto;
        border: 2px solid #eee;
        border-radius: 8px;
        overflow: hidden; /* Taşmaları gizle */
        position: relative;
    }

    #qr-reader {
        width: 100%;
        background-color: #000; /* Kamera açılana kadar siyah */
    }

    #qr-reader video {
        width: 100% !important;
        height: auto !important;
        display: block;
    }

    /* Tarama alanı (çerçeve) */
    #qr-reader__scan_region {
        /* Bu, kütüphanenin eklediği bir div, ortalayalım */
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* Tarama kutusu için sahte çerçeve (isteğe bağlı) */
    .scan-box-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 250px;
        height: 250px;
        border: 3px solid rgba(255, 255, 255, 0.7);
        box-shadow: 0 0 0 400px rgba(0, 0, 0, 0.3); /* Dışını karart */
        border-radius: 5px;
        pointer-events: none; /* Üzerine tıklanamaz */
    }

    #qr-reader-results {
        margin-top: 15px; 
        font-weight: bold; 
        min-height: 2em; /* Mesaj alanı */
        word-break: break-all; /* Uzun URL'ler taşmasın */
    }
</style>
{% endblock %}


{# Ana içerik bloğunu doldur (base.html'deki) #}
{% block content %}
<div class="card shadow-sm">
    <div class="card-body p-4 text-center">

        <h1 class="h3 mb-3">Mola QR Kodu Tarayıcı</h1>
        <p class="text-muted">Lütfen mola başlatmak veya bitirmek için şubenizdeki QR kodu tarayın.</p>

        <div id="qr-reader-wrapper">
            <div id="qr-reader"></div>
            <div class="scan-box-overlay"></div> {# Sahte çerçeve #}
        </div>

        <div id="qr-reader-results" class="mt-3">
            <span class="text-muted fst-italic">Kamera başlatılıyor...</span>
        </div>

        <div class="controls mt-3 d-grid gap-2 d-sm-flex justify-content-sm-center">
            <button id="startButton" class="btn btn-coffee"><i class="bi bi-play-fill"></i> Taramayı Başlat</button>
            <button id="stopButton" class="btn btn-danger" disabled><i class="bi bi-stop-fill"></i> Durdur</button>
        </div>

    </div>
</div>
{% endblock %}


{# Bu sayfaya özel script'leri base.html'deki scripts bloğuna gönder #}
{% block scripts %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
    const resultElement = document.getElementById('qr-reader-results');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');

    // Html5Qrcode tarayıcı objesini global yapalım
    const html5QrCode = new Html5Qrcode("qr-reader"); // id'si "qr-reader" olan div'i kullanacak

    // Tarama başarılı olduğunda çalışacak fonksiyon
    function onScanSuccess(decodedText, decodedResult) {
        console.log(`Kod bulundu! = ${decodedText}`);
        resultElement.innerHTML = `<div class="alert alert-info">Kod bulundu, kontrol ediliyor...</div>`;
        stopScanning(); // Taramayı durdur

        var siteOrigin = window.location.origin; // "https://www.geekpanel.net"

        // GÜVENLİK KONTROLÜ VE HATA MESAJI
        if (decodedText.startsWith(siteOrigin) && decodedText.includes("/app/mola/")) {
            // BAŞARILI DURUM
            resultElement.innerHTML = `<div class="alert alert-success">Geçerli kod bulundu! Yönlendiriliyor...</div>`;
            // Yönlendirmeyi yap
            window.location.href = decodedText;
        } else {
            // BAŞARISIZ DURUM - NEDENİNİ GÖSTER
            resultElement.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <h4 class="alert-heading" style="font-size: 1.1rem;">GEÇERSİZ QR KOD!</h4>
                    <p>Okunan kod (${siteOrigin}) adresi ile başlamıyor veya mola URL'i değil.</p>
                    <hr>
                    <p class="mb-0" style="font-size: 0.9em;">Lütfen şubenizdeki doğru QR kodu okuttuğunuzdan emin olun.</p>
                    <small style="font-size: 0.8em; word-wrap: break-word;">(Okunan Değer: ${decodedText})</small>
                </div>
            `;
            startButton.disabled = false; // Tekrar denemesine izin ver
        }
    }

    // Tarama sırasında hata olursa çalışacak fonksiyon
    function onScanFailure(error) {
        // "QR code not found" hatasını görmezden gel, bu normaldir
        if (!error.includes("QR code not found")) {
            console.warn(`Kod tarama hatası = ${error}`);
        }
    }

    // Taramayı başlatan fonksiyon
    function startScanning() {
        resultElement.innerHTML = `<span class="text-muted fst-italic">Kamera başlatılıyor...</span>`;
        startButton.disabled = true;

        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        // Sadece ARKA KAMERAYI ('environment') iste
        const cameraConfig = { facingMode: "environment" };

        html5QrCode.start(cameraConfig, config, onScanSuccess, onScanFailure)
        .then(() => {
            console.log("Tarama başlatıldı.");
            resultElement.innerHTML = `<span class="text-muted fst-italic">QR kod aranıyor...</span>`;
            stopButton.disabled = false;
        }).catch(err => {
            console.error(`Tarama başlatılamadı: ${err}`);
            let userMessage = `Kamera başlatılamadı veya izin verilmedi. Lütfen sayfa ayarlarından (tarayıcı adres çubuğundaki kilit ikonu) kamera iznini kontrol edin.`;
            if (location.protocol !== 'https:**' && !['localhost', '127.0.0.1'].includes(location.hostname)) {
                 userMessage += "<br><strong>Güvenli bağlantı (HTTPS) kamera için gereklidir.</strong>";
            }
            resultElement.innerHTML = `<div class="alert alert-danger">${userMessage}</div>`;
            startButton.disabled = false;
            stopButton.disabled = true;
        });
    }

    // Taramayı durduran fonksiyon
    function stopScanning() {
        try {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(ignore => {
                    console.log("Tarama durduruldu.");
                    resultElement.innerHTML = `<span class="text-muted fst-italic">Tarama durduruldu.</span>`;
                    startButton.disabled = false;
                    stopButton.disabled = true;
                }).catch(err => { console.error(`Tarama düzgün durdurulamadı: ${err}`); });
            }
        } catch (e) {
            console.warn("Tarama durdurulurken hata oluştu (muhtemelen zaten kapalıydı):", e);
            startButton.disabled = false;
            stopButton.disabled = true;
        }
    }

    // Sayfa yüklendiğinde butonları ayarla
    document.addEventListener('DOMContentLoaded', (event) => {
        startButton.disabled = false;
        startButton.onclick = startScanning;
        stopButton.onclick = stopScanning;

        if (location.protocol !== 'https:' && !['localhost', '127.0.0.1'].includes(location.hostname)) {
             resultElement.innerHTML = `<div class="alert alert-warning">Güvenli bağlantı (HTTPS) olmadığı için kamera çalışmayabilir.</div>`;
             startButton.disabled = true;
        }
    });

    // Sayfadan ayrılırken kamerayı kapat (çok önemli!)
    window.addEventListener('beforeunload', function (e) {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop();
        }
    });
</script>
{% endblock %}