{% extends 'base.html' %}
{% load static %}
{% load pwa %}

{% block title %}Mola QR Kodu Tarayıcı{% endblock %}

{% block head_styles %}
<style>
    main.container { max-width: 600px; }
    #qr-reader { width: 100%; border: 1px solid #ccc; background-color: #eee; position: relative; overflow: hidden; }
    #qr-reader video { width: 100%; height: auto; display: block; }
    #qr-reader-results { margin-top: 15px; font-weight: bold; min-height: 1.5em; }
    .status-message { color: #555; font-style: italic;}
</style>
{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-body p-4 text-center">
        <h1 class="h3 mb-3">Mola QR Kodu Tarayıcı</h1>
        <p class="text-muted">Lütfen mola başlatmak veya bitirmek için şubenizdeki QR kodu tarayın.</p>
        <div id="qr-reader" class="rounded">
            <span class="status-message p-4 d-block">Kamera bekleniyor...</span>
        </div>
        <div id="qr-reader-results" class="mt-3"></div>
        <div class="controls mt-3 d-grid gap-2 d-sm-flex justify-content-sm-center">
            <button id="startButton" class="btn btn-coffee" disabled><i class="bi bi-play-fill"></i> Taramayı Başlat</button>
            <button id="stopButton" class="btn btn-danger" disabled><i class="bi bi-stop-fill"></i> Durdur</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
    const qrReaderElement = document.getElementById('qr-reader');
    const resultElement = document.getElementById('qr-reader-results');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const statusMessageSpan = qrReaderElement.querySelector('.status-message');
    let html5QrCode = null;

    function onScanSuccess(decodedText, decodedResult) {
        console.log(`Kod bulundu! = ${decodedText}`, decodedResult);
        resultElement.textContent = `Kod bulundu, kontrol ediliyor...`;
        stopScanning();
        var siteOrigin = window.location.origin; // "https://www.geekpanel.net"

        // GÜVENLİK KONTROLÜ VE HATA MESAJI
        if (decodedText.startsWith(siteOrigin) && decodedText.includes("/app/mola/")) {
            resultElement.textContent = `Geçerli kod bulundu! Yönlendiriliyor...`;
            resultElement.style.color = 'var(--coffee-medium)';
            window.location.href = decodedText;
        } else {
            // GEÇERSİZ KOD İÇİN HATA GÖSTER
            resultElement.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <h4 class="alert-heading" style="font-size: 1.1rem;">GEÇERSİZ QR KOD!</h4>
                    <p>Okunan kod, bu site (${siteOrigin}) için geçerli bir mola kodu değil.</p>
                    <hr>
                    <p class="mb-0" style="font-size: 0.9em;">Lütfen şubenizdeki doğru QR kodu okuttuğunuzdan emin olun.</p>
                    <small style="font-size: 0.8em; word-wrap: break-word;">(Okunan Değer: ${decodedText})</small>
                </div>
            `;
            startButton.disabled = false;
        }
    }
    function onScanFailure(error) { }

    function startScanning() {
        if (!html5QrCode) { resultElement.innerHTML = `<div class="alert alert-danger">Tarayıcı başlatılamadı.</div>`; return; }
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        const cameraConfig = { facingMode: "environment" }; // Arka kamerayı iste

        html5QrCode.start(cameraConfig, config, onScanSuccess, onScanFailure)
        .then(() => {
            console.log("Tarama başlatıldı.");
            resultElement.textContent = "QR kod aranıyor..."; resultElement.style.color = '#555';
            startButton.disabled = true; stopButton.disabled = false;
            if(statusMessageSpan) statusMessageSpan.style.display = 'none';
        }).catch(err => {
            let userMessage = `Kamera başlatılamadı veya izin verilmedi. Lütfen sayfa ayarlarından kamera iznini kontrol edin.`;
            if (location.protocol !== 'https:' && !['localhost', '127.0.0.1'].includes(location.hostname)) {
                 userMessage += "<br><strong>Güvenli bağlantı (HTTPS) gerekli olabilir.</strong>";
            }
            resultElement.innerHTML = `<div class="alert alert-danger">${userMessage}</div>`;
            startButton.disabled = false; stopButton.disabled = true;
        });
    }
    function stopScanning() {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().then(ignore => {
                console.log("Tarama durduruldu.");
                resultElement.textContent = "Tarama durduruldu."; resultElement.style.color = '#555';
                startButton.disabled = false; stopButton.disabled = true;
                 if(statusMessageSpan) statusMessageSpan.style.display = 'block';
            }).catch(err => { console.error(`Tarama durdurulamadı: ${err}`); });
        }
    }
    document.addEventListener('DOMContentLoaded', (event) => {
        html5QrCode = new Html5Qrcode("qr-reader");
        startButton.disabled = false;
        startButton.onclick = startScanning;
        stopButton.onclick = stopScanning;
        if (location.protocol !== 'https:' && !['localhost', '127.0.0.1'].includes(location.hostname)) {
             resultElement.innerHTML = `<div class="alert alert-warning">Güvenli bağlantı (HTTPS) olmadığı için kamera çalışmayabilir.</div>`;
             startButton.disabled = true;
        }
    });
    window.addEventListener('beforeunload', function (e) { stopScanning(); });
</script>
{% endblock %}