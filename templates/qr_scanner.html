{% extends 'base.html' %}
{% load static %}

{% block title %}Mola QR Kodu Tarayıcı{% endblock %}

{% block head_styles %}
<style>
    /* Tarayıcıyı ortalamak için base.html'deki dikey ortalamayı kullanalım */
    .content-wrapper {
        justify-content: center;
    }
    main.container {
        margin-top: 0 !important;
        margin-bottom: 0 !important;
        max-width: 600px; /* Konteyneri daralt */
    }
    /* Footer'ı bu sayfada gizle */
    .footer {
        display: none;
    }

    #qr-reader {
        width: 100%;
        border: 1px solid #ccc;
        background-color: #eee;
        position: relative;
    }
    #qr-reader-results {
        margin-top: 15px; font-weight: bold; min-height: 1.5em;
    }
    .status-message { color: #555; font-style: italic;}
    .error-message { color: #dc3545; font-weight: bold;}
</style>
{% endblock %}


{% block content %}
<div class="card shadow-sm">
    <div class="card-body p-4 text-center">

        <h1 class="h3 mb-3">Mola QR Kodu Tarayıcı</h1>
        <p class="text-muted">Lütfen mola başlatmak veya bitirmek için şubenizdeki QR kodu tarayın.</p>

        <div id="qr-reader">
            <span class="status-message p-4 d-block">Kamera bekleniyor...</span>
        </div>

        <div id="qr-reader-results"></div>

        <div class="controls mt-3 d-grid gap-2 d-sm-flex justify-content-sm-center">
            <button id="startButton" class="btn btn-coffee" disabled><i class="bi bi-play-fill"></i> Taramayı Başlat</button>
            <button id="stopButton" class="btn btn-danger" disabled><i class="bi bi-stop-fill"></i> Durdur</button>
        </div>

        <a href="{% url 'accounts:dashboard' %}" class="btn btn-link mt-3">&laquo; Ana Panele Geri Dön</a>

    </div>
</div>
{% endblock %}


{% block scripts %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
        const qrReaderElement = document.getElementById('qr-reader');
        const resultElement = document.getElementById('qr-reader-results');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const statusMessageSpan = qrReaderElement.querySelector('.status-message');

        let html5QrCode = null; // Tarayıcı objesini tutacak değişken

        // Tarama başarılı olduğunda çalışacak fonksiyon
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Kod bulundu! = ${decodedText}`, decodedResult);
            resultElement.textContent = `Kod bulundu! Yönlendiriliyor...`;
            resultElement.style.color = '#28a745';
            stopScanning();

            // GÜVENLİK KONTROLÜ: Sadece bu sitenin URL'lerine yönlendir
            // window.location.origin -> https://www.geekpanel.net
            if (decodedText.startsWith(window.location.origin)) {
                window.location.href = decodedText;
            } else {
                 console.warn("Harici veya geçersiz (örn: http://) bir URL tarandı, yönlendirme engellendi:", decodedText);
                 resultElement.textContent = "Geçersiz QR kod tarandı. Lütfen doğru kodu okutun.";
                 resultElement.style.color = '#dc3545';
                 startButton.disabled = false; // Tekrar denemesine izin ver
            }
        }

        // Tarama sırasında hata olursa çalışacak fonksiyon (opsiyonel)
        function onScanFailure(error) {
            // Sürekli log basmaması için sessiz kalabilir
        }

        // Taramayı başlatan fonksiyon
        function startScanning() {
            if (!html5QrCode) {
                 console.error("Tarayıcı objesi başlatılamadı.");
                 resultElement.textContent = "Tarayıcı başlatılamadı.";
                 resultElement.style.color = '#dc3545';
                 return;
            }
            
            // Tarama ayarları (Saniyede 10 kare, tarama kutusu boyutu)
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            // Kamera ayarları: Açıkça ARKA KAMERAYI ('environment') iste
            const cameraConfig = { facingMode: "environment" };

            // Seçilen kamera ile taramayı başlat
            html5QrCode.start(
                cameraConfig,      // Arka kamerayı iste
                config,            // Tarama ayarları
                onScanSuccess,     // Başarı fonksiyonu
                onScanFailure      // Hata fonksiyonu
            ).then(() => {
                console.log("Tarama başlatıldı.");
                resultElement.textContent = "QR kod aranıyor...";
                resultElement.style.color = '#555';
                startButton.disabled = true;
                stopButton.disabled = false;
                if(statusMessageSpan) statusMessageSpan.style.display = 'none'; // "Kamera bekleniyor" mesajını gizle
            }).catch(err => {
                console.error(`Tarama başlatılamadı: ${err}`);
                resultElement.textContent = `Kamera başlatılamadı veya izin verilmedi. Hata: ${err}`;
                resultElement.style.color = '#dc3545';
                startButton.disabled = false; // Tekrar denemek için butonu aktif et
                stopButton.disabled = true;
            });
        }

        // Taramayı durduran fonksiyon
        function stopScanning() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(ignore => {
                    console.log("Tarama durduruldu.");
                    resultElement.textContent = "Tarama durduruldu.";
                    resultElement.style.color = '#555';
                    startButton.disabled = false;
                    stopButton.disabled = true;
                     if(statusMessageSpan) statusMessageSpan.style.display = 'block';
                }).catch(err => { console.error(`Tarama durdurulamadı: ${err}`); });
            }
        }

        // Sayfa yüklendiğinde tarayıcıyı başlat ve butonları ayarla
        document.addEventListener('DOMContentLoaded', (event) => {
            html5QrCode = new Html5Qrcode("qr-reader");
            startButton.disabled = false;
            startButton.onclick = startScanning;
            stopButton.onclick = stopScanning;

            // HTTPS Koruması
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                 resultElement.textContent = "Güvenli bağlantı (HTTPS) gerekli olduğu için kamera çalışmayabilir.";
                 resultElement.style.color = '#dc3545';
                 startButton.disabled = true;
            }
        });

        // Sayfadan ayrılırken taramayı durdur
        window.addEventListener('beforeunload', function (e) {
            stopScanning();
        });
    </script>
{% endblock %}