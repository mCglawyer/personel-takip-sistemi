{% load static %}
{% load custom_filters %} {# get_item filtresi için #}
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ selected_branch.name }} - Haftalık Vardiya Planlama</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 40px; background-color: #f9f9f9; margin: 0;}
        .container { max-width: 1400px; /* Geniş tablo için */ margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 20px; flex-wrap: wrap;}
        .header h1 { margin: 0; font-size: 1.8rem; margin-bottom: 5px;}
        .header .sub-info { font-size: 1.1rem; color: #555; display: block;} /* Şube adı ve geri linki */
        .header a { text-decoration: none; background-color: #007bff; color: white; padding: 8px 15px; border-radius: 5px; font-weight: 600; white-space: nowrap;}
        .back-to-select { margin-left: 15px; font-size: 0.9rem; color: #555;} /* Şube seçimine geri dön linki */

        /* Planlama Tablosu Stilleri */
        .schedule-table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; /* Sütun genişliklerini sabitler */ }
        .schedule-table th, .schedule-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .schedule-table th { background-color: #f4f4f4; font-weight: 600; text-align: center; }

        /* İlk sütun (Personel Adı) */
        .schedule-table th:nth-child(1), .schedule-table td:nth-child(1) {
            width: 180px; /* Genişlik */
            font-weight: bold;
            background-color: #f8f9fa;
            position: sticky; /* Sola sabitleme */
            left: 0;          /* Sola sabitleme */
            z-index: 1;       /* Diğerlerinin üstünde kalsın */
        }
        /* ŞUBE SÜTUNU ARTIK YOK */

        .schedule-table select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff; /* Seçili olmayanların arka planı */
        }

        /* Kaydedilmiş vardiyaları renklendirme (CSS class'ları ile) */
        .schedule-table select.shift-SABAH { background-color: #e6f7ff; border-color: #91d5ff; }
        .schedule-table select.shift-ARACI { background-color: #fffbe6; border-color: #ffe58f; }
        .schedule-table select.shift-AKSAM { background-color: #fff0f6; border-color: #ffadd2; }
        .schedule-table select.shift-IZIN { background-color: #f6f6f6; border-color: #d9d9d9; font-style: italic; color: #888;}
        .schedule-table select.shift-ETKINLIK { background-color: #f9f0ff; border-color: #d3adf7; }
        .schedule-table select.shift-RAPORLU { background-color: #fff3cd; border-color: #ffeeba; color: #856404; font-weight: bold;} /* Sarı tonu */
        .schedule-table select.shift-DEVAMSIZ { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; font-weight: bold;} /* Kırmızı tonu */

        .save-button {
            margin-top: 20px; padding: 12px 24px; font-size: 1.2rem;
            background-color: #28a745; color: white; border: none;
            border-radius: 5px; cursor: pointer;
        }
        .save-button:hover { background-color: #218838; }

        /* Tabloyu yatay kaydırılabilir yapmak için */
        .table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
             <div> {# Başlık ve alt bilgi için gruplama #}
                <h1>Haftalık Vardiya Planlama</h1>
                <span class="sub-info">
                    <strong>Şube:</strong> {{ selected_branch.name }}
                     <a href="{% url 'accounts:weekly_schedule_select' %}" class="back-to-select">(Başka Şube Seç)</a> {# Namespace kullanıldı #}
                </span>
            </div>
            <a href="{% url 'accounts:dashboard' %}">Ana Panele Geri Dön</a> {# Namespace kullanıldı #}
        </div>

        <div class="content">
            {# Formun action'ı boş, yani aynı URL'e POST edecek (/app/schedule/weekly/<branch_id>/) #}
            <form method="POST">
                {% csrf_token %}
                <p><strong>Gösterilen Hafta:</strong> {{ week_days.0|date:"d N Y" }} - {{ week_days.6|date:"d N Y" }}</p>

                <div class="table-wrapper"> {# Yatay kaydırma için tabloyu sarmaladık #}
                    <table class="schedule-table">
                        <thead>
                            <tr>
                                <th>Personel</th>
                                {# ŞUBE SÜTUNU BAŞLIĞI KALDIRILDI #}
                                {% for day in week_days %}
                                    <th>
                                        {{ day|date:"l" }} <br>
                                        <small>{{ day|date:"d N" }}</small>
                                    </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {# Sadece bu şubeye atanmış personeller (views.py'dan filtrelenmiş geldi) #}
                            {% for p in all_personnel %}
                            <tr>
                                <td>{{ p.first_name }} {{ p.last_name }}<br><small>({{ p.username }})</small></td>

                                {# ŞUBE SEÇİM KUTUSU KALDIRILDI #}

                                {% for day in week_days %}
                                    {% with day_str=day|date:'Y-m-d' %}
                                    {# O gün için kayıtlı vardiyayı 'shifts_map' içinden bul #}
                                    {% with current_shift=shifts_map|get_item:p.id|get_item:day_str %}
                                    <td>
                                        <select name="shift_{{ p.id }}_{{ day_str }}"
                                                class="{% if current_shift %}shift-{{ current_shift.shift_type }}{% endif %}"> {# Renk için CSS class'ı ekle #}

                                            <option value="">--- Seçiniz ---</option> {# Boş seçeneği silmek için #}
                                            {% for type_key, type_name in shift_types %} {# views.py'dan gelen liste #}
                                                <option value="{{ type_key }}"
                                                    {% if current_shift and current_shift.shift_type == type_key %}selected{% endif %}>
                                                    {# Sadece Açıklama (örn: Sabahçı (07:30..)) #}
                                                    {{ type_name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    {% endwith %} {# current_shift #}
                                    {% endwith %} {# day_str #}
                                {% endfor %} {# week_days #}
                            </tr>
                            {% empty %} {# Eğer o şubeye atanmış personel yoksa #}
                            <tr>
                                {# Sütun sayısı artık 8 (Personel + 7 gün) #}
                                <td colspan="8" style="text-align: center; padding: 20px;">
                                    Bu şubeye atanmış personel bulunmamaktadır. Lütfen <a href="/admin/auth/user/">admin panelinden</a> personellere şube atayın.
                                </td>
                            </tr>
                            {% endfor %} {# all_personnel #}
                        </tbody>
                    </table>
                </div> {# table-wrapper bitti #}

                <button type="submit" class="save-button">
                    {{ selected_branch.name }} İçin Haftalık Planı Kaydet
                </button>
            </form>
        </div>
    </div>
</body>
</html>